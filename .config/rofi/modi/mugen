#!/bin/sh
mugen_host=${MUGEN_HOST:-https://kara.moe}
kara_api="${MUGEN_KARA_API:-$mugen_host/api/karas}"
collections=asia,geek,world,shitpost
karamedia="${MUGEN_KARAOKEMEDIA:-$mugen_host/downloads}"

# karaoke medias and lyrics directories
medias="$karamedia/medias"
lyrics="$karamedia/lyrics"

if [ -z "$@" ]; then
    # cache results for 30 minutes
    karas=/tmp/$USER-mugen-karas
    find "$karas" -mmin 30 > /dev/null 2>&1 || (curl "$kara_api?collections=$collections" | jq -r '.content | .[] | "\(.mediafile)\u0000info\u001f\(.kid)"' > "$karas")
    cat "$karas"
    exit 0
fi

# choose karaoke
kid=$ROFI_INFO
[ -z "$kid" ] && exit

# find karaoke files
kara="$(curl "$kara_api/$kid" | jq '{mediafile: .mediafile, subfile: .subfile, gain: .gain}')"
media="$(echo "$kara" | jq -r '.mediafile' | sed 's/#/%23/g')"
sub="$(echo "$kara" | jq -r '.subfile' | sed 's/#/%23/g')"
gain="$(echo "$kara" | jq -r '.gain')"

mpv --replaygain-fallback=$gain --sub-file="$lyrics/$sub" "$medias/$media" > /dev/null 2>&1 &
exec 1>&-
